# КРИТИЧЕСКИЕ ИСПРАВЛЕНИЯ ДАШБОРДА

**Проблема:** Дашборд показывает некорректные данные, описания нечитаемые, внизу нули.

---

## 🔴 ПРОБЛЕМА 1: "0 frames" в заголовке

### Что сейчас:
```
27.2 sec
0 frames   ← НЕПРАВИЛЬНО
```

### Как исправить:
В `processor.py` убедиться, что `total_frames` передаётся в дашборд:

```python
# В process_video():
result = {
    'total_frames': int(cap.get(cv2.CAP_PROP_FRAME_COUNT)),  # НЕ 0!
    'duration': total_frames / fps,
    # ...
}
```

Проверить в `dashboard.py`:
```python
# При отрисовке заголовка:
frames = data.get('total_frames', 0)
if frames == 0:
    # Вычислить из duration и fps
    frames = int(data.get('duration', 0) * 25)  # default 25 fps
```

---

## 🔴 ПРОБЛЕМА 2: Внизу все нули (0% Продуктивность, 0% Экономичность, 0% Баланс)

### Что сейчас:
```
27%         0%            0%           0%
Стабильность  Продуктивность  Экономичность  Баланс
```

### Причина:
Эти метрики либо не вычисляются, либо не передаются в дашборд.

### Как исправить:

**1. Убрать метрики которых нет в спецификации!**

В спецификации ALGORITHM_SPEC.md есть 5 дополнительных метрик:
- Стабильность (stability)
- Истощение (exhaustion)
- Эффективность рук (arm_efficiency) 
- Эффективность ног (leg_efficiency)
- Восстановление (recovery)

**НЕТ** метрик: Продуктивность, Экономичность, Баланс.

**Заменить нижнюю панель на правильные метрики:**

```python
ADDITIONAL_METRICS_CONFIG = [
    {
        "key": "stability",
        "name": "Стабильность",
        "hint": "контроль положения тела"
    },
    {
        "key": "exhaustion", 
        "name": "Истощение",
        "hint": "усталость к финишу"
    },
    {
        "key": "arm_efficiency",
        "name": "Руки",
        "hint": "% нагрузки на руки"
    },
    {
        "key": "leg_efficiency",
        "name": "Ноги", 
        "hint": "% нагрузки на ноги"
    },
    {
        "key": "recovery",
        "name": "Восстановление",
        "hint": "качество отдыха"
    }
]
```

---

## 🔴 ПРОБЛЕМА 3: DM 4%, RR 0% — неправильные расчёты

### Что сейчас:
- DM (Diagonal Movement / Противовес) = 4% ← подозрительно низко
- RR (Route Reading / Считывание) = 0% ← явный баг

### Причины и исправления:

#### DM (Diagonal Movement) — Противовес

**Формула (из ALGORITHM_SPEC.md):**
```python
def calculate_diagonal_coordination(movement_history):
    """
    Корреляция движений противоположных конечностей.
    
    Если нет движения (статика) — НЕ считать как 0!
    """
    if len(movement_history) < 10:
        return 50  # Недостаточно данных — средний балл, НЕ НОЛЬ
    
    correlations = []
    
    for i in range(1, len(movement_history)):
        prev = movement_history[i-1]
        curr = movement_history[i]
        
        # Движение правой руки
        rh_move = distance(curr.right_wrist, prev.right_wrist)
        # Движение левой ноги
        lf_move = distance(curr.left_ankle, prev.left_ankle)
        # Движение левой руки
        lh_move = distance(curr.left_wrist, prev.left_wrist)
        # Движение правой ноги
        rf_move = distance(curr.right_ankle, prev.right_ankle)
        
        # Если оба двигаются — считаем корреляцию
        if rh_move > threshold and lf_move > threshold:
            # Диагональ работает
            correlations.append(1.0)
        elif lh_move > threshold and rf_move > threshold:
            # Диагональ работает
            correlations.append(1.0)
        elif rh_move > threshold or lh_move > threshold:
            # Только руки двигаются без противовеса
            correlations.append(0.3)
        else:
            # Статика — не учитываем
            pass
    
    if len(correlations) == 0:
        return 60  # Преимущественно статика — нормально
    
    # Преобразуем в проценты
    score = mean(correlations) * 100
    return max(10, min(100, score))  # Clamp 10-100, НИКОГДА 0
```

**ВАЖНО:** Если человек лезет статично (мало динамики) — это НЕ значит что диагональ плохая!

#### RR (Route Reading) — Считывание

**Формула (из ALGORITHM_SPEC.md):**
```python
def calculate_route_reading(timeline_data):
    """
    Анализ пауз и времени до первого движения.
    
    ПРОБЛЕМА: если timeline_data пустой — возвращает 0
    РЕШЕНИЕ: установить дефолтное значение
    """
    # Время до первого движения
    time_before_start = timeline_data.get('first_movement_time', 2.0)  # default 2 сек
    
    # Количество пауз для просмотра
    reading_pauses = timeline_data.get('reading_pauses_count', 1)  # default 1
    
    # Если данных нет — вернуть средний балл
    if time_before_start is None:
        time_before_start = 2.0
    if reading_pauses is None:
        reading_pauses = 1
    
    # Расчёт
    # До 5 сек подготовки = хорошо
    start_score = min(time_before_start / 5.0, 1.0) * 50
    
    # 3+ паузы = хорошо
    pause_score = min(reading_pauses / 3, 1.0) * 50
    
    total = start_score + pause_score
    
    return max(20, min(100, total))  # Минимум 20, НИКОГДА 0
```

**ВАЖНО:** RR = 0% — это БАГ. Даже если человек сразу стартует без пауз, это минимум 20-30%, не 0%.

---

## 🔴 ПРОБЛЕМА 4: Описания метрик нечитаемые

### Что сейчас:
Длинные тексты мелким шрифтом, сливаются друг с другом.

### Как исправить:

**Убрать длинные описания из левой колонки!**

Оставить только:
- Название метрики (жирным)
- Прогресс-бар
- Процент

```python
def draw_metric_row(ax, y, metric_name, metric_abbr, score, color):
    """
    Компактная строка метрики БЕЗ длинного описания.
    """
    # Аббревиатура слева
    ax.text(5, y, metric_abbr, fontsize=11, fontweight='bold', color='white')
    
    # Прогресс-бар
    bar_x = 40
    bar_width = 200
    bar_height = 12
    
    # Фон бара
    ax.add_patch(Rectangle((bar_x, y-6), bar_width, bar_height, 
                           facecolor='#333333'))
    # Заполнение
    fill_width = bar_width * score / 100
    ax.add_patch(Rectangle((bar_x, y-6), fill_width, bar_height,
                           facecolor=color))
    
    # Процент справа
    ax.text(bar_x + bar_width + 10, y, f"{int(score)}%", 
            fontsize=11, fontweight='bold', color=color)
```

**Описания вынести в тултипы или убрать совсем.**

Если нужны описания — сделать их КОРОТКИМИ (1 строка):

| Метрика | Короткое описание |
|---------|-------------------|
| QF | Точность постановки ног |
| HP | Положение таза у стены |
| DM | Диагональная координация |
| RR | Планирование маршрута |
| RT | Равномерность темпа |
| DC | Контроль после бросков |
| GR | Плавность перехватов |

---

## 🔴 ПРОБЛЕМА 5: Общий балл и уровень

### Что сейчас:
```
Общий балл: 44/100
Уровень: до 5a
```

### Формула расчёта общего балла:

```python
def calculate_overall_score(technique_metrics):
    """
    Взвешенная сумма 7 базовых метрик.
    """
    weights = {
        "quiet_feet": 0.20,
        "hip_position": 0.20,
        "diagonal": 0.15,
        "grip_release": 0.15,
        "rhythm": 0.10,
        "dynamic_control": 0.10,
        "route_reading": 0.10
    }
    
    total = 0
    weight_sum = 0
    
    for metric, weight in weights.items():
        score = technique_metrics.get(metric, {}).get('score')
        if score is not None and score > 0:
            total += score * weight
            weight_sum += weight
    
    if weight_sum == 0:
        return 50  # Default, не 0!
    
    return total / weight_sum * (weight_sum / 1.0)  # Нормализация
```

### Формула определения уровня:

```python
def estimate_grade(overall_score):
    """
    Таблица соответствия балла и уровня.
    """
    grade_table = [
        (90, "7b+"),
        (85, "7a—7b"),
        (80, "6c—7a"),
        (75, "6b—6c"),
        (70, "6a—6b"),
        (65, "5c—6a"),
        (60, "5b—5c"),
        (50, "5a—5b"),
        (0, "до 5a")
    ]
    
    for threshold, grade in grade_table:
        if overall_score >= threshold:
            return grade
    
    return "до 5a"
```

**При балле 44 — уровень "до 5a" корректен.**

Но если метрики считаются неправильно (DM=4%, RR=0%), то и общий балл занижен!

---

## 🔴 ПРОБЛЕМА 6: Руки 69%, Ноги 80%

### Что сейчас:
```
69%        80%
Руки       Ноги
```

### Это ХОРОШО или ПЛОХО?

**Руки 69%** — это процент НАГРУЗКИ, не эффективности!
- Если руки несут 69% веса — это ПЛОХО (норма 30-40%)
- Если это эффективность работы рук — нужно уточнить

**Ноги 80%** — если это нагрузка, то ОТЛИЧНО (норма 60-70%)

### Нужно ЧЁТКО разделить:

```python
# Вариант 1: Показываем НАГРУЗКУ (% веса)
"Руки: 35%"   # сколько веса на руках — меньше = лучше
"Ноги: 65%"   # сколько веса на ногах — больше = лучше

# Вариант 2: Показываем ЭФФЕКТИВНОСТЬ
"Эфф. рук: 78%"   # насколько правильно работают руки
"Эфф. ног: 82%"   # насколько активно используются ноги
```

**Рекомендация:** Показывать НАГРУЗКУ с пояснением:

```
Руки: 35% веса ✓    Ноги: 65% веса ✓
(норма 30-40%)      (норма 60-70%)
```

---

## ✅ ИТОГОВЫЙ ЧЕКЛИСТ

### Исправить расчёты:
- [ ] DM (Diagonal) — добавить дефолт 50-60%, не 0%
- [ ] RR (Route Reading) — добавить дефолт 30%, не 0%
- [ ] Все метрики — минимум 10%, НИКОГДА 0% (если есть данные)
- [ ] total_frames — брать из видео, не 0

### Исправить дашборд:
- [ ] Убрать длинные описания метрик (оставить только короткие)
- [ ] Заменить нижние метрики на правильные (stability, exhaustion, arm_efficiency, leg_efficiency, recovery)
- [ ] Добавить подписи "% нагрузки" для рук/ног
- [ ] Увеличить шрифты (минимум 10pt для описаний)

### Проверить передачу данных:
- [ ] processor.py → возвращает все метрики
- [ ] dashboard.py → получает все метрики
- [ ] Логировать значения перед отрисовкой

---

## 📝 ПРИМЕР ПРАВИЛЬНОГО ДАШБОРДА

```
┌─────────────────────────────────────────────────────────────┐
│  ClimbAI                                21.01.2026          │
│  BoulderVision Analysis                 27.2 sec            │
│                                         680 frames          │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  QF  ████████████████░░░░  78%     ┌─────────────┐         │
│  HP  ██████████░░░░░░░░░░  52%     │  ПАУТИНКА   │         │
│  DM  ████████████████████  94%     │   7 осей    │         │
│  RR  █████████████░░░░░░░  65%     │             │         │
│  RT  ███████████░░░░░░░░░  57%     │  Score: 71  │         │
│  DC  ███████████████░░░░░  77%     │ Уровень:6a-6b│        │
│  GR  █████████████████░░░  85%     └─────────────┘         │
│                                                              │
├─────────────────────────────────────────────────────────────┤
│  СИЛЬНЫЕ СТОРОНЫ          │  СЛАБЫЕ СТОРОНЫ                │
│  • DM 94% — диагональ     │  • HP 52% — таз далеко        │
│  • GR 85% — плавность     │  • RT 57% — рваный ритм       │
├─────────────────────────────────────────────────────────────┤
│  ВОЗМОЖНОСТИ              │  РИСКИ                         │
│  • Таз ближе → -30%       │  • Левое плечо — зажим        │
│    нагрузки на руки       │  • Истощение 68%              │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  87%      68%       35%      65%      74%                  │
│  Стаб.    Истощ.    Руки     Ноги     Восст.               │
│                     (веса)   (веса)                         │
│                                                              │
├─────────────────────────────────────────────────────────────┤
│  Методология: Eric J. Hörst    Сгенерировано: 21.01.2026   │
└─────────────────────────────────────────────────────────────┘
```

---

## 🚨 ПРИОРИТЕТ ИСПРАВЛЕНИЙ

1. **СРОЧНО:** Исправить расчёт DM и RR (убрать нули)
2. **СРОЧНО:** Исправить total_frames = 0
3. **ВАЖНО:** Заменить нижние метрики на правильные
4. **ВАЖНО:** Убрать длинные описания
5. **ЖЕЛАТЕЛЬНО:** Добавить пояснения к рукам/ногам
