# Патчи Quiet Feet: план внедрения

## Что делаем

Два независимых патча, которые работают на разных уровнях:

### Патч 1: Rotation Filter (уровень данных)
**Файл:** `app/analysis/technique_metrics.py`

Фильтрует на этапе сбора: если стопа осталась в том же кластере, но повернулась на ≥15° — это пивот (техника), а не перестановка (ошибка). Не считаем.

**Что меняется:**
- Новый метод `_calc_foot_angle()` — угол пятка→носок
- Новый буфер `foot_angle_history` в `__init__`
- Замена `_count_repositions()` → `_count_repositions_with_rotation_filter()`
- Формула скора **без изменений** — просто на вход подаются чистые данные

**Порог пивота:** 15° (настраиваемый). Если стопа повернулась меньше 15° — это ёрзанье, считаем. Больше 15° — пивот, не считаем.

**Чувствительность кластеризации:** 0.02 — **не трогаем** (как просили).

### Патч 2: Grade-Aware Filter (уровень отчёта)
**Файл:** `app/analysis/swot_generator.py`

Страховка: даже если после rotation filter что-то просочилось, для 7a+ бот не будет писать «критично для прогресса».

**Что меняется:**
- Порог weakness для `quiet_feet`: 55 → 40 (для 7a+)
- Порог weakness для `rhythm`: 55 → 45 (для 7a+)
- Порог weakness для `route_reading`: 55 → 40 (для 7a+)
- Тексты: вместо «Ноги ищут зацепку» → «Есть пространство для повышения точности постановки. На вашем уровне это тонкая настройка»
- Opportunity: вместо «уберёт 19 лишних движений» → «тонкий резерв экономии на длинных маршрутах»

**Триггер:** `estimated_grade` содержит 7 или 8 (автоматически).

## Порядок внедрения

```
1. Rotation Filter       → прогнать то же видео → сравнить repositions
2. Если ОК               → Grade-Aware Filter
3. Финальный прогон       → проверить отчёт
```

## Что ожидаем на выходе

**До патчей** (текущий отчёт):
- quiet_feet: 19 перестановок / 6 лишних (рассогласовано)
- текст: «Ноги ищут зацепку — критично для прогресса»
- weakness: quiet_feet попал в слабые стороны

**После патча 1** (rotation filter):
- Часть из 19 отфильтруется как пивоты (ожидаю 40-60% — будет ~8-11)
- Скор quiet_feet вырастет
- Числа repositions и saved согласуются (оба из одного источника)

**После патча 2** (grade-aware):
- Если quiet_feet всё ещё < 55 но > 40 → НЕ попадёт в weakness для 7a+
- Если < 40 → попадёт, но с адекватным текстом
- Opportunity тоже адаптирован

## Риски

- **Порог пивота 15°** — может быть слишком мягким или жёстким. Нужно посмотреть логи после первого прогона. Если всё ещё много ложных перестановок — поднять до 20°. Если фильтрует слишком много — опустить до 10°.
- **Grade detection** — зависит от `estimated_grade`. Если grade ошибочно низкий, адаптация не включится. Но это ок — лучше перебдеть.

## Отладка

В патче 1 есть `_log_quiet_feet_debug()` — после прогона покажет:
```
QuietFeet [left]:  repositions=5, pivots=8 (62% filtered), stable_positions=12, avg=0.42
QuietFeet [right]: repositions=3, pivots=6 (67% filtered), stable_positions=10, avg=0.30
```

По этим числам сразу видно — адекватно ли фильтрует.
