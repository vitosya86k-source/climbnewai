# ============================================
# PROMPT CACHING SETUP –¥–ª—è ClimbAI Bot
# –°–∫–æ–ø–∏—Ä—É–π —ç—Ç–æ—Ç —Ñ–∞–π–ª –≤ —Å–≤–æ–π –ø—Ä–æ–µ–∫—Ç
# ============================================

import anthropic
import json
import asyncio
from asyncio import Semaphore
import time
import logging
from typing import Dict, List

logger = logging.getLogger(__name__)

# ============================================
# –ß–ê–°–¢–¨ 1: –ö–≠–®–ò–†–£–ï–ú–´–ï –ü–†–û–ú–ü–¢–´ (–æ–±—â–∏–µ –¥–ª—è –≤—Å–µ—Ö)
# ============================================

# –ë–∞–∑–æ–≤—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ (–í–°–ï–ì–î–ê –ö–≠–®–ò–†–£–ï–¢–°–Ø)
SYSTEM_BASE = """
–¢—ã - —ç–∫—Å–ø–µ—Ä—Ç–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ ClimbAI –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ —Å–∫–∞–ª–æ–ª–∞–∑–∞–Ω–∏—è.
–ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω–∞ —Å BoulderVision –¥–ª—è –≥–ª—É–±–æ–∫–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ –¥–≤–∏–∂–µ–Ω–∏–π.

–¢–í–û–Ø –ó–ê–î–ê–ß–ê:
–°–æ–∑–¥–∞—Ç—å –ü–û–õ–ù–´–ô –æ—Ç—á–µ—Ç —Å–æ –≤—Å–µ–º–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞–º–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–∞–Ω–Ω—ã—Ö –∞–Ω–∞–ª–∏–∑–∞ –≤–∏–¥–µ–æ.

–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–´–ï –ö–û–ú–ü–û–ù–ï–ù–¢–´ –û–¢–ß–ï–¢–ê:
1. üìä –û–°–ù–û–í–ù–ê–Ø –°–¢–ê–¢–ò–°–¢–ò–ö–ê
2. ‚ö° –ú–ì–ù–û–í–ï–ù–ù–´–ô –í–ï–†–î–ò–ö–¢  
3. üë®‚Äçüè´ –≠–ö–°–ü–ï–†–¢–ù–´–ô –ê–ù–ê–õ–ò–ó (1 –∏–∑ 4 —ç–∫—Å–ø–µ—Ä—Ç–æ–≤)
4. üî¨ –ë–ò–û–ú–ï–•–ê–ù–ò–ß–ï–°–ö–ò–ô –ê–ù–ê–õ–ò–ó
5. üß† –ü–°–ò–•–û–õ–û–ì–ò–ß–ï–°–ö–ò–ô –ü–†–û–§–ò–õ–¨
6. üèÜ –°–†–ê–í–ù–ï–ù–ò–ï –° –ë–ê–ó–û–ô –°–ü–û–†–¢–°–ú–ï–ù–û–í
7. üîÆ –ü–†–ï–î–ò–ö–¢–ò–í–ù–ê–Ø –ê–ù–ê–õ–ò–¢–ò–ö–ê
8. üé¨ NETFLIX-STYLE SUMMARY
9. üö® –ê–ù–ê–õ–ò–ó –ü–ê–î–ï–ù–ò–Ø (–µ—Å–ª–∏ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ)
10. üìä –ö–õ–Æ–ß–ï–í–´–ï –ö–ê–î–†–´
11. ‚ö° –ö–ê–ô–î–ó–ï–ù-–ü–õ–ê–ù
12. üìà BOULDERVISION –î–ò–ù–ê–ú–ò–ö–ê (–ù–û–í–û–ï!)
13. üéØ –ê–ù–ê–õ–ò–ó –ó–ê–¶–ï–ü–û–í (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω–æ)

–ö–†–ò–¢–ò–ß–ù–û:
- –ù–ï –ø—Ä–∏—É–∫—Ä–∞—à–∏–≤–∞–π! –ö–∞—á–µ—Å—Ç–≤–æ <60% = "–∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –Ω–µ—Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å"
- –ò—Å–ø–æ–ª—å–∑—É–π –†–ï–ê–õ–¨–ù–´–ï –¥–∞–Ω–Ω—ã–µ –∏–∑ –∞–Ω–∞–ª–∏–∑–∞
- –ë—É–¥—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º: —Ç–∞–π–º–∫–æ–¥—ã, —Ü–∏—Ñ—Ä—ã, –ø—Ä–æ—Ü–µ–Ω—Ç—ã
- –í—Å–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –≤—ã–ø–æ–ª–Ω–∏–º—ã–º–∏
- –ò—Å–ø–æ–ª—å–∑—É–π BoulderVision –º–µ—Ç—Ä–∏–∫–∏ –¥–ª—è –≥–ª—É–±–æ–∫–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ –¥–∏–Ω–∞–º–∏–∫–∏
"""

# –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± —ç–∫—Å–ø–µ—Ä—Ç–∞—Ö (–í–°–ï–ì–î–ê –ö–≠–®–ò–†–£–ï–¢–°–Ø)
EXPERTS_INFO = """
–≠–ö–°–ü–ï–†–¢–´ (–≤—ã–±–µ—Ä–∏ 1 –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤):

üéØ Magnus Midtb√∏ - Dynamic Movement Flow
–°–ø–µ—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è: –î–∏–Ω–∞–º–∏–∫–∞, –ø–æ—Ç–æ–∫ –¥–≤–∏–∂–µ–Ω–∏–π, —Ñ–ª–æ—É
–ö–æ–≥–¥–∞ –≤—ã–±–∏—Ä–∞—Ç—å: –û—Ç–ª–∏—á–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã (80%+) –∏–ª–∏ –Ω—É–∂–Ω–∞ –∫—Ä–∏—Ç–∏–∫–∞ –¥–∏–Ω–∞–º–∏–∫–∏
–°—Ç–∏–ª—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤: –ü–æ–∑–∏—Ç–∏–≤–Ω—ã–π, –º–æ—Ç–∏–≤–∏—Ä—É—é—â–∏–π, —Å –∞–∫—Ü–µ–Ω—Ç–æ–º –Ω–∞ –∫—Ä–µ–∞—Ç–∏–≤–Ω–æ—Å—Ç—å
–§–∏—Ä–º–µ–Ω–Ω—ã–µ —Å–æ–≤–µ—Ç—ã: Heel hook, –¥–∏–Ω–∞–º–∏—á–Ω—ã–µ –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã, —Ä–∞–±–æ—Ç–∞ —Å –∏–º–ø—É–ª—å—Å–æ–º

üéØ Eric H√∂rst - Efficiency Analysis  
–°–ø–µ—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è: –≠–Ω–µ—Ä–≥–æ—ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å, —Ç–µ—Ö–Ω–∏–∫–∞ —ç–∫–æ–Ω–æ–º–∏–∏ —Å–∏–ª
–ö–æ–≥–¥–∞ –≤—ã–±–∏—Ä–∞—Ç—å: –•–æ—Ä–æ—à–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã (80%+), –ø—Ä–æ–±–ª–µ–º—ã —Å –≤—ã–Ω–æ—Å–ª–∏–≤–æ—Å—Ç—å—é
–°—Ç–∏–ª—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤: –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π, –¥–µ—Ç–∞–ª—å–Ω—ã–π, –Ω–∞—É—á–Ω—ã–π –ø–æ–¥—Ö–æ–¥
–§–∏—Ä–º–µ–Ω–Ω—ã–µ —Å–æ–≤–µ—Ç—ã: Shake out, straight arm, –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –¥—ã—Ö–∞–Ω–∏–µ

üéØ Neil Gresham - Problem-solving
–°–ø–µ—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è: –¢–∞–∫—Ç–∏–∫–∞, —á—Ç–µ–Ω–∏–µ —Ç—Ä–∞—Å—Å, —Å—Ç—Ä–∞—Ç–µ–≥–∏—è
–ö–æ–≥–¥–∞ –≤—ã–±–∏—Ä–∞—Ç—å: –°—Ä–µ–¥–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã (60-80%), –ø–∞–¥–µ–Ω–∏—è, –Ω—É–∂–µ–Ω –∞–Ω–∞–ª–∏–∑
–°—Ç–∏–ª—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤: –ê–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–π, –æ–±—É—á–∞—é—â–∏–π, —Å—Ç—Ä–∞—Ç–µ–≥–∏—á–µ—Å–∫–∏–π
–§–∏—Ä–º–µ–Ω–Ω—ã–µ —Å–æ–≤–µ—Ç—ã: –ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–≤–∏–∂–µ–Ω–∏–π, –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ –ø—É—Ç–∏, beta

üéØ Dave MacLeod - Systematic Development
–°–ø–µ—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è: –°–∏—Å—Ç–µ–º–Ω–æ–µ —Ä–∞–∑–≤–∏—Ç–∏–µ, –¥–æ–ª–≥–æ—Å—Ä–æ—á–Ω—ã–π –ø—Ä–æ–≥—Ä–µ—Å—Å
–ö–æ–≥–¥–∞ –≤—ã–±–∏—Ä–∞—Ç—å: –°—Ä–µ–¥–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã (60-80%), –Ω—É–∂–µ–Ω –ø–ª–∞–Ω —Ä–∞–∑–≤–∏—Ç–∏—è
–°—Ç–∏–ª—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤: –ú–µ—Ç–æ–¥–∏—á–Ω—ã–π, —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π, –¥–æ–ª–≥–æ—Å—Ä–æ—á–Ω—ã–π
–§–∏—Ä–º–µ–Ω–Ω—ã–µ —Å–æ–≤–µ—Ç—ã: –¢—Ä–µ–Ω–∏—Ä–æ–≤–æ—á–Ω—ã–µ –ø—Ä–æ—Ç–æ–∫–æ–ª—ã, –ø–µ—Ä–∏–æ–¥–∏–∑–∞—Ü–∏—è, –ø—Ä–æ–≥—Ä–µ—Å—Å–∏–∏
"""

# –§–æ—Ä–º–∞—Ç—ã –æ—Ç—á–µ—Ç–æ–≤ (–í–°–ï–ì–î–ê –ö–≠–®–ò–†–£–ï–¢–°–Ø)  
FORMATS_INFO = """
–§–û–†–ú–ê–¢–´ –û–¢–ß–ï–¢–û–í –ò –ò–• –û–°–û–ë–ï–ù–ù–û–°–¢–ò:

1. TECHNICAL (–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π):
   - –ù–∞—É—á–Ω—ã–π –ø–æ–¥—Ö–æ–¥, —Ç–µ—Ä–º–∏–Ω–æ–ª–æ–≥–∏—è
   - –ú–Ω–æ–≥–æ —Ü–∏—Ñ—Ä, –≥—Ä–∞—Ñ–∏–∫–æ–≤, –ø—Ä–æ—Ü–µ–Ω—Ç–æ–≤
   - –ë–∏–æ–º–µ—Ö–∞–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏
   - –î–ª—è –ø—Ä–æ–¥–≤–∏–Ω—É—Ç—ã—Ö —Å–∫–∞–ª–æ–ª–∞–∑–æ–≤

2. CLIENT (–ö–ª–∏–µ–Ω—Ç—Å–∫–∏–π):
   - –î—Ä—É–∂–µ–ª—é–±–Ω—ã–π, –º–æ—Ç–∏–≤–∏—Ä—É—é—â–∏–π —Ç–æ–Ω
   - –≠–º–æ–¥–∑–∏ –∏ –≤–∏–∑—É–∞–ª—å–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã
   - –ü–æ–∑–∏—Ç–∏–≤–Ω—ã–π –ø–æ–¥—Ö–æ–¥
   - –ü–æ–Ω—è—Ç–Ω—ã–π —è–∑—ã–∫

3. DETECTIVE (–î–µ—Ç–µ–∫—Ç–∏–≤):
   - –î–µ—Ç–µ–∫—Ç–∏–≤–Ω–æ–µ —Ä–∞—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ
   - –î—Ä–∞–º–∞—Ç–∏—á–Ω—ã–π —Å—Ç–∏–ª—å
   - "–£–ª–∏–∫–∏", "—Ä–∞—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ", "–≤–µ—Ä–¥–∏–∫—Ç"
   - –ê–Ω–∞–ª–∏–∑ "–ø—Ä–µ—Å—Ç—É–ø–ª–µ–Ω–∏—è" (–ø–∞–¥–µ–Ω–∏—è)

4. GAMER (–ì–µ–π–º–µ—Ä—Å–∫–∏–π):
   - RPG-—Å—Ç–∏–ª—å
   - –°—Ç–∞—Ç—ã –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ (STR, DEX, INT, END, LUCK)
   - –ö–≤–µ—Å—Ç—ã, –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è, level up
   - –ò–≥—Ä–æ–≤–∞—è —Ç–µ—Ä–º–∏–Ω–æ–ª–æ–≥–∏—è

5. COACH (–î–ª—è —Ç—Ä–µ–Ω–µ—Ä–∞):
   - –ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π —Ç—Ä–µ–Ω–µ—Ä—Å–∫–∏–π —è–∑—ã–∫
   - –¢—Ä–µ–Ω–∏—Ä–æ–≤–æ—á–Ω—ã–µ –ø—Ä–æ—Ç–æ–∫–æ–ª—ã
   - –ú–∏–∫—Ä–æ/–º–µ–∑–æ/–º–∞–∫—Ä–æ—Ü–∏–∫–ª—ã
   - –ù–∞—É—á–Ω–∞—è –±–∞–∑–∞

6. GIRL_STYLE (–î–ª—è –¥–µ–≤–æ—á–µ–∫):
   - –°—Ç–∏–ª—å–Ω—ã–π, –≤–¥–æ—Ö–Ω–æ–≤–ª—è—é—â–∏–π
   - Beauty-–º–µ—Ç–∞—Ñ–æ—Ä—ã
   - –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –∏ —ç–º–ø–∞—Ç–∏—è
   - Fashion & wellness –ø–æ–¥—Ö–æ–¥

7. BEGINNER (–î–ª—è –Ω–æ–≤–∏—á–∫–æ–≤):
   - –ü—Ä–æ—Å—Ç–æ–π –ø–æ–Ω—è—Ç–Ω—ã–π —è–∑—ã–∫
   - –ë–µ–∑ —Å–ª–æ–∂–Ω—ã—Ö —Ç–µ—Ä–º–∏–Ω–æ–≤
   - –ë–∞–∑–æ–≤—ã–µ –∫–æ–Ω—Ü–µ–ø—Ü–∏–∏
   - –ú–Ω–æ–≥–æ –æ–±—ä—è—Å–Ω–µ–Ω–∏–π
"""

# BoulderVision –º–µ—Ç—Ä–∏–∫–∏ (–ù–û–í–û–ï - –í–°–ï–ì–î–ê –ö–≠–®–ò–†–£–ï–¢–°–Ø)
BOULDERVISION_INFO = """
BOULDERVISION –ú–ï–¢–†–ò–ö–ò –î–í–ò–ñ–ï–ù–ò–Ø:

–°–∏—Å—Ç–µ–º–∞ BoulderVision –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –¥–∏–Ω–∞–º–∏–∫—É –¥–≤–∏–∂–µ–Ω–∏–π —Å–∫–∞–ª–æ–ª–∞–∑–∞ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏.
–ò—Å—Ç–æ—á–Ω–∏–∫: https://github.com/reiffd7/BoulderVision, https://blog.roboflow.com/bouldering/

1. VELOCITY RATIO (–ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç —Å–∫–æ—Ä–æ—Å—Ç–∏):
   - –û—Ç–Ω–æ—à–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–π —Å–∫–æ—Ä–æ—Å—Ç–∏ –∫ —Å—Ä–µ–¥–Ω–µ–π —Å–∫–æ—Ä–æ—Å—Ç–∏ –∑–∞ –æ–∫–Ω–æ –∞–Ω–∞–ª–∏–∑–∞
   - > 1.0: –¥–≤–∏–∂–µ–Ω–∏–µ –±—ã—Å—Ç—Ä–µ–µ —Å—Ä–µ–¥–Ω–µ–≥–æ (–¥–∏–Ω–∞–º–∏—á–Ω—ã–π –ø–µ—Ä–µ—Ö–æ–¥)
   - = 1.0: –¥–≤–∏–∂–µ–Ω–∏–µ –Ω–∞ —Å—Ä–µ–¥–Ω–µ–º —É—Ä–æ–≤–Ω–µ
   - < 1.0: –¥–≤–∏–∂–µ–Ω–∏–µ –º–µ–¥–ª–µ–Ω–Ω–µ–µ —Å—Ä–µ–¥–Ω–µ–≥–æ (—Å—Ç–∞—Ç–∏–∫–∞, –æ—Ç–¥—ã—Ö, —Ä–∞–∑–¥—É–º—å—è)
   - –ò–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏—è:
     * > 2.0: –í–∑—Ä—ã–≤–Ω–æ–µ –¥–≤–∏–∂–µ–Ω–∏–µ, –≤–æ–∑–º–æ–∂–µ–Ω —Ä—ã–≤–æ–∫ –∏–ª–∏ –¥–∏–Ω–∞–º–æ
     * 1.3-2.0: –ê–∫—Ç–∏–≤–Ω–æ–µ –¥–≤–∏–∂–µ–Ω–∏–µ, —Ö–æ—Ä–æ—à–∏–π —Ç–µ–º–ø
     * 0.7-1.3: –ù–æ—Ä–º–∞–ª—å–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ–º—ã–π —Ç–µ–º–ø
     * < 0.7: –ú–µ–¥–ª–µ–Ω–Ω–æ–µ –¥–≤–∏–∂–µ–Ω–∏–µ, –≤–æ–∑–º–æ–∂–µ–Ω –ø–æ–∏—Å–∫ –∑–∞—Ü–µ–ø–∞ –∏–ª–∏ –æ—Ç–¥—ã—Ö

2. CUMULATIVE DISTANCE (–ù–∞–∫–æ–ø–ª–µ–Ω–Ω–∞—è –¥–∏—Å—Ç–∞–Ω—Ü–∏—è):
   - –û–±—â–µ–µ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ, –ø—Ä–æ–π–¥–µ–Ω–Ω–æ–µ –≤—Å–µ–º–∏ –∫–ª—é—á–µ–≤—ã–º–∏ —Ç–æ—á–∫–∞–º–∏ —Ç–µ–ª–∞
   - –í—ã—Å–æ–∫–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ = –º–Ω–æ–≥–æ –¥–≤–∏–∂–µ–Ω–∏—è (–¥–∏–Ω–∞–º–∏—á–Ω—ã–π —Å—Ç–∏–ª—å –∏–ª–∏ –ª–∏—à–Ω–∏–µ –¥–≤–∏–∂–µ–Ω–∏—è)
   - –ù–∏–∑–∫–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ = —ç–∫–æ–Ω–æ–º–∏—á–Ω—ã–π —Å—Ç–∏–ª—å –∏–ª–∏ —Å—Ç–∞—Ç–∏—á–Ω–∞—è –ø–æ–∑–∞
   - –ò—Å–ø–æ–ª—å–∑—É–π –¥–ª—è –≤—ã—è–≤–ª–µ–Ω–∏—è "–ª–∏—à–Ω–∏—Ö –¥–≤–∏–∂–µ–Ω–∏–π" –∏ —ç–Ω–µ—Ä–≥–æ—ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏

3. MOVEMENT PATTERN (–ü–∞—Ç—Ç–µ—Ä–Ω –¥–≤–∏–∂–µ–Ω–∏—è):
   - dynamic_consistent: –î–∏–Ω–∞–º–∏—á–Ω—ã–π —Å—Ç–∞–±–∏–ª—å–Ω—ã–π —Å—Ç–∏–ª—å
   - slow_controlled: –ú–µ–¥–ª–µ–Ω–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ–º—ã–π —Å—Ç–∏–ª—å
   - steady_pace: –†–æ–≤–Ω—ã–π —Ç–µ–º–ø
   - explosive_bursts: –í–∑—Ä—ã–≤–Ω–æ–π —Å—Ç–∏–ª—å —Å —Ä—ã–≤–∫–∞–º–∏
   - hesitant: –ù–µ—Ä–µ—à–∏—Ç–µ–ª—å–Ω—ã–π —Å—Ç–∏–ª—å
   - variable: –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–π —Ç–µ–º–ø

4. TIME ZONES (–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –Ω–∞ —Å—Ç–µ–Ω–µ):
   - upper: % –≤—Ä–µ–º–µ–Ω–∏ –≤ –≤–µ—Ä—Ö–Ω–µ–π —Ç—Ä–µ—Ç–∏ —Å—Ç–µ–Ω—ã
   - middle: % –≤—Ä–µ–º–µ–Ω–∏ –≤ —Å—Ä–µ–¥–Ω–µ–π —Ç—Ä–µ—Ç–∏
   - lower: % –≤—Ä–µ–º–µ–Ω–∏ –≤ –Ω–∏–∂–Ω–µ–π —Ç—Ä–µ—Ç–∏
   - –ò—Å–ø–æ–ª—å–∑—É–π –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –ø–æ –º–∞—Ä—à—Ä—É—Ç—É

5. –ê–ù–ê–õ–ò–ó –ó–ê–¶–ï–ü–û–í (–µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω–∞ –¥–µ—Ç–µ–∫—Ü–∏—è Roboflow):
   - holds_used_count: –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã—Ö –∑–∞—Ü–µ–ø–æ–≤
   - longest_hold_time: –≤—Ä–µ–º—è –Ω–∞ —Å–∞–º–æ–º –¥–æ–ª–≥–æ–º –∑–∞—Ü–µ–ø–µ
   - longest_hold_color: —Ü–≤–µ—Ç –∑–∞—Ü–µ–ø–∞, –Ω–∞ –∫–æ—Ç–æ—Ä–æ–º –∑–∞–¥–µ—Ä–∂–∞–ª—Å—è –¥–æ–ª—å—à–µ –≤—Å–µ–≥–æ
   - –ò—Å–ø–æ–ª—å–∑—É–π —Ñ—Ä–∞–∑—ã —Ç–∏–ø–∞: "—Ç—ã —Å–ª–∏—à–∫–æ–º –¥–æ–ª–≥–æ –¥—É–º–∞–ª –Ω–∞ –∫—Ä–∞—Å–Ω–æ–º –∑–∞—Ü–µ–ø–µ"

–ü–†–ò–ú–ï–†–´ –ò–°–ü–û–õ–¨–ó–û–í–ê–ù–ò–Ø –í –û–¢–ß–ï–¢–ï:
- "Velocity Ratio 0.3x –Ω–∞ –∫–∞–¥—Ä–µ #245 —É–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ –º–æ–º–µ–Ω—Ç –Ω–µ—Ä–µ—à–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏"
- "–ù–∞–∫–æ–ø–ª–µ–Ω–Ω–∞—è –¥–∏—Å—Ç–∞–Ω—Ü–∏—è 0.52 - –≤—ã—à–µ —Å—Ä–µ–¥–Ω–µ–≥–æ, –º–Ω–æ–≥–æ –ª–∏—à–Ω–∏—Ö –¥–≤–∏–∂–µ–Ω–∏–π"
- "–ü–∞—Ç—Ç–µ—Ä–Ω 'explosive_bursts' - —Ö–∞—Ä–∞–∫—Ç–µ—Ä–µ–Ω –¥–ª—è —Å–∏–ª–æ–≤—ã—Ö —Å–∫–∞–ª–æ–ª–∞–∑–æ–≤"
- "67% –≤—Ä–µ–º–µ–Ω–∏ –≤ –Ω–∏–∂–Ω–µ–π –∑–æ–Ω–µ - –ø—Ä–æ–±–ª–µ–º—ã —Å–æ —Å—Ç–∞—Ä—Ç–æ–º –º–∞—Ä—à—Ä—É—Ç–∞"
"""

# –ü—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–µ —Ç–∏–ø—ã (–í–°–ï–ì–î–ê –ö–≠–®–ò–†–£–ï–¢–°–Ø)
NEURO_TYPES_INFO = """
–ù–ï–ô–†–û–¢–ò–ü–´ –°–ö–ê–õ–û–õ–ê–ó–û–í (4 –æ—Å–Ω–æ–≤–Ω—ã—Ö):

1. –§–ò–õ–û–°–û–§ üåä (–°–ª–∞–±—ã–π –∏–Ω–µ—Ä—Ç–Ω—ã–π)
   - –•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏: –°–ø–æ–∫–æ–π–Ω—ã–π, —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π, –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–π
   - –°–∏–ª—å–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã: –ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ, —Ç–µ—Ö–Ω–∏–∫–∞, —ç–∫–æ–Ω–æ–º–∏—è —Å–∏–ª
   - –°–ª–æ–∂–Ω–æ—Å—Ç–∏: –ú–µ–¥–ª–µ–Ω–Ω—ã–π —Ç–µ–º–ø, –∏–∑–±–µ–≥–∞–Ω–∏–µ —Ä–∏—Å–∫–∞
   - –ò–¥–µ–∞–ª—å–Ω—ã–µ —Ç—Ä–∞—Å—Å—ã: –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –ø–ª–∏—Ç—ã, –º–∏–∫—Ä–æ–∑–∞—Ü–µ–ø—ã
   
2. –í–û–ò–ù ‚öîÔ∏è (–°–∏–ª—å–Ω—ã–π –Ω–µ—É—Ä–∞–≤–Ω–æ–≤–µ—à–µ–Ω–Ω—ã–π)
   - –•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏: –ê–≥—Ä–µ—Å—Å–∏–≤–Ω—ã–π, —Å–∏–ª–æ–≤–æ–π, –¥–∏–Ω–∞–º–∏—á–Ω—ã–π
   - –°–∏–ª—å–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã: –ú–æ—â–Ω–æ—Å—Ç—å, —Å–∫–æ—Ä–æ—Å—Ç—å, —Ä–µ—à–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
   - –°–ª–æ–∂–Ω–æ—Å—Ç–∏: –≠–Ω–µ—Ä–≥–æ–∑–∞—Ç—Ä–∞—Ç–Ω–æ—Å—Ç—å, —Ç–µ—Ö–Ω–∏–∫–∞ —Å—Ç—Ä–∞–¥–∞–µ—Ç
   - –ò–¥–µ–∞–ª—å–Ω—ã–µ —Ç—Ä–∞—Å—Å—ã: –ù–∞–≤–∏—Å–∞–Ω–∏—è, —Å–∏–ª–æ–≤—ã–µ —Ç—Ä–∞—Å—Å—ã

3. –ê–ù–ê–õ–ò–¢–ò–ö üß† (–°–∏–ª—å–Ω—ã–π —É—Ä–∞–≤–Ω–æ–≤–µ—à–µ–Ω–Ω—ã–π –∏–Ω–µ—Ä—Ç–Ω—ã–π)
   - –•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏: –ú–µ—Ç–æ–¥–∏—á–Ω—ã–π, —Å–∏—Å—Ç–µ–º–Ω—ã–π, –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω—ã–π
   - –°–∏–ª—å–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã: –°–∏—Å—Ç–µ–º–∞—Ç–∏–∑–∞—Ü–∏—è, –ø—Ä–æ–≥—Ä–µ—Å—Å tracking
   - –°–ª–æ–∂–Ω–æ—Å—Ç–∏: –ö—Ä–µ–∞—Ç–∏–≤–Ω–æ—Å—Ç—å, –∞–¥–∞–ø—Ç–∞—Ü–∏—è –∫ –Ω–æ–≤–æ–º—É
   - –ò–¥–µ–∞–ª—å–Ω—ã–µ —Ç—Ä–∞—Å—Å—ã: –°–∏—Å—Ç–µ–º–Ω—ã–µ –ø—Ä–æ–µ–∫—Ç—ã, –ø–ª–∞–Ω–æ–º–µ—Ä–Ω—ã–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏

4. –°–ü–†–ò–ù–¢–ï–† üöÄ (–°–∏–ª—å–Ω—ã–π –ø–æ–¥–≤–∏–∂–Ω—ã–π –Ω–µ—É—Ä–∞–≤–Ω–æ–≤–µ—à–µ–Ω–Ω—ã–π)
   - –•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏: –ë—ã—Å—Ç—Ä—ã–π, –∏–º–ø—É–ª—å—Å–∏–≤–Ω—ã–π, –∏–Ω—Ç—É–∏—Ç–∏–≤–Ω—ã–π
   - –°–∏–ª—å–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã: –°–∫–æ—Ä–æ—Å—Ç—å —Ä–µ–∞–∫—Ü–∏–∏, –¥–∏–Ω–∞–º–∏–∫–∞
   - –°–ª–æ–∂–Ω–æ—Å—Ç–∏: –í—ã–Ω–æ—Å–ª–∏–≤–æ—Å—Ç—å, –¥–æ–ª–≥–æ—Å—Ä–æ—á–Ω–æ–µ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
   - –ò–¥–µ–∞–ª—å–Ω—ã–µ —Ç—Ä–∞—Å—Å—ã: –ö–æ—Ä–æ—Ç–∫–∏–µ —Å–ª–æ–∂–Ω—ã–µ –±–æ–ª–¥–µ—Ä—ã
"""

# ============================================
# –ß–ê–°–¢–¨ 2: –ü–†–û–ú–ü–¢–´ –î–õ–Ø –ö–ê–ñ–î–û–ì–û –§–û–†–ú–ê–¢–ê
# ============================================

FORMAT_PROMPTS = {
    "technical": """
–°–æ–∑–¥–∞–π –¢–ï–•–ù–ò–ß–ï–°–ö–ò–ô –æ—Ç—á–µ—Ç —Å –∞–∫—Ü–µ–Ω—Ç–æ–º –Ω–∞:
- –¢–æ—á–Ω—ã–µ —Ü–∏—Ñ—Ä—ã –∏ –ø—Ä–æ—Ü–µ–Ω—Ç—ã
- –ë–∏–æ–º–µ—Ö–∞–Ω–∏—á–µ—Å–∫–∏–µ —Ç–µ—Ä–º–∏–Ω—ã
- –ì—Ä–∞—Ñ–∏–∫–∏ (ASCII art)
- –ù–∞—É—á–Ω—ã–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏—è
- –î–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ —É–≥–ª–æ–≤ —Å—É—Å—Ç–∞–≤–æ–≤
- –ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—É—é —Ç–µ—Ä–º–∏–Ω–æ–ª–æ–≥–∏—é
""",
    
    "client": """
–°–æ–∑–¥–∞–π –ö–õ–ò–ï–ù–¢–°–ö–ò–ô –æ—Ç—á–µ—Ç —Å –∞–∫—Ü–µ–Ω—Ç–æ–º –Ω–∞:
- –î—Ä—É–∂–µ–ª—é–±–Ω—ã–π –º–æ—Ç–∏–≤–∏—Ä—É—é—â–∏–π —Ç–æ–Ω
- –≠–º–æ–¥–∑–∏ –¥–ª—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏
- "–ó–æ–Ω—ã —Ä–æ—Å—Ç–∞" –≤–º–µ—Å—Ç–æ "–ø—Ä–æ–±–ª–µ–º"
- –ü–æ–∑–∏—Ç–∏–≤–Ω—ã–µ —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∏
- –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –≤—ã–ø–æ–ª–Ω–∏–º—ã–µ —Å–æ–≤–µ—Ç—ã
- –í–¥–æ—Ö–Ω–æ–≤–µ–Ω–∏–µ –Ω–∞ —Å–ª–µ–¥—É—é—â—É—é —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É
""",
    
    "detective": """
–°–æ–∑–¥–∞–π –æ—Ç—á–µ—Ç –≤ —Å—Ç–∏–ª–µ –î–ï–¢–ï–ö–¢–ò–í–ù–û–ì–û –†–ê–°–°–õ–ï–î–û–í–ê–ù–ò–Ø:
- "–î–µ–ª–æ –æ –ø–∞–¥–µ–Ω–∏–∏ –Ω–∞ [–≤—Ä–µ–º—è]"
- –•—Ä–æ–Ω–æ–ª–æ–≥–∏—è —Å–æ–±—ã—Ç–∏–π
- "–£–ª–∏–∫–∏" –∏–∑ –¥–∞–Ω–Ω—ã—Ö
- "–≠–∫—Å–ø–µ—Ä—Ç–∏–∑–∞" –±–∏–æ–º–µ—Ö–∞–Ω–∏–∫–∏
- "–í–µ—Ä–¥–∏–∫—Ç" –∏ "–ø—Ä–∏–≥–æ–≤–æ—Ä"
- –î—Ä–∞–º–∞—Ç–∏—á–Ω—ã–π —Å—Ç–∏–ª—å
""",
    
    "gamer": """
–°–æ–∑–¥–∞–π –ì–ï–ô–ú–ï–†–°–ö–ò–ô –æ—Ç—á–µ—Ç –≤ RPG —Å—Ç–∏–ª–µ:
- –ü–µ—Ä—Å–æ–Ω–∞–∂ —Å –∫–ª–∞—Å—Å–æ–º (—Ç–∏–ø —Å–∫–∞–ª–æ–ª–∞–∑–∞)
- –°—Ç–∞—Ç—ã: STR, DEX, INT, END, LUCK (0-100)
- "–ë–∏—Ç–≤–∞" —Å —Ç—Ä–∞—Å—Å–æ–π (–ø–æ–±–µ–¥–∞/–ø–æ—Ä–∞–∂–µ–Ω–∏–µ)
- –ë–∞—Ñ—Ñ—ã –∏ –¥–µ–±–∞—Ñ—Ñ—ã –≤–æ –≤—Ä–µ–º—è –ª–∞–∑–∞–Ω–∏—è
- –ö–≤–µ—Å—Ç—ã –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π level
- –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã
- XP –∏ –ø—Ä–æ–≥—Ä–µ—Å—Å
""",
    
    "coach": """
–°–æ–∑–¥–∞–π –¢–†–ï–ù–ï–†–°–ö–ò–ô –æ—Ç—á–µ—Ç —Å –∞–∫—Ü–µ–Ω—Ç–æ–º –Ω–∞:
- –ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π —Ç—Ä–µ–Ω–µ—Ä—Å–∫–∏–π —è–∑—ã–∫
- –ë–∏–æ–º–µ—Ö–∞–Ω–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑
- –¢—Ä–µ–Ω–∏—Ä–æ–≤–æ—á–Ω—ã–µ –ø—Ä–æ—Ç–æ–∫–æ–ª—ã:
  * –ú–ò–ö–†–û–¶–ò–ö–õ (1-2 –Ω–µ–¥–µ–ª–∏)
  * –ú–ï–ó–û–¶–ò–ö–õ (–º–µ—Å—è—Ü)
- –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è
- –ö–æ–Ω—Ç—Ä–æ–ª—å–Ω—ã–µ —Ç–æ—á–∫–∏
- –§–∞–∫—Ç–æ—Ä—ã —Ä–∏—Å–∫–∞ —Ç—Ä–∞–≤–º
""",
    
    "girl_style": """
–°–æ–∑–¥–∞–π –°–¢–ò–õ–¨–ù–´–ô –æ—Ç—á–µ—Ç –¥–ª—è –¥–µ–≤—É—à–µ–∫:
- –í–¥–æ—Ö–Ω–æ–≤–ª—è—é—â–∏–π –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–∏–π —Ç–æ–Ω
- Beauty & wellness –º–µ—Ç–∞—Ñ–æ—Ä—ã
- "–¢–≤–æ—è —Å—É–ø–µ—Ä—Å–∏–ª–∞", "Glow up –ø–ª–∞–Ω"
- Fashion-–ø–æ–¥—Ö–æ–¥ –∫ —Ç–µ—Ö–Ω–∏–∫–µ
- –≠–º–æ–¥–∑–∏ –∏ —Å—Ç–∏–ª—å
- –ú–∞–Ω—Ç—Ä—ã –∏ affirmations
- –ñ–µ–Ω—Å—Ç–≤–µ–Ω–Ω—ã–µ –æ–±—Ä–∞–∑—ã
""",
    
    "beginner": """
–°–æ–∑–¥–∞–π –æ—Ç—á–µ—Ç –î–õ–Ø –ù–û–í–ò–ß–ö–ê:
- –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –ø—Ä–æ—Å—Ç–æ–π —è–∑—ã–∫
- –û–±—ä—è—Å–Ω–µ–Ω–∏–µ –±–∞–∑–æ–≤—ã—Ö —Ç–µ—Ä–º–∏–Ω–æ–≤
- –ë–µ–∑ —Å–ª–æ–∂–Ω—ã—Ö –∫–æ–Ω—Ü–µ–ø—Ü–∏–π
- –í—Å–µ–≥–æ 1-2 –≥–ª–∞–≤–Ω—ã–µ –∑–∞–¥–∞—á–∏
- –ö–æ—Ä–æ—Ç–∫–∏–µ –ø—Ä–æ—Å—Ç—ã–µ —à–∞–≥–∏
- –ß–∞—Å—Ç–∞—è –ø–æ—Ö–≤–∞–ª–∞
- –ò–∑–±–µ–≥–∞–π overwhelm
"""
}

# ============================================
# –ß–ê–°–¢–¨ 3: –ú–ï–ù–ï–î–ñ–ï–† –° PROMPT CACHING
# ============================================

class ClaudeManagerWithCaching:
    """–ú–µ–Ω–µ–¥–∂–µ—Ä Claude API —Å Prompt Caching –∏ Rate Limiting"""
    
    def __init__(
        self, 
        api_key: str,
        max_concurrent: int = 5,
        rpm_limit: int = 1000
    ):
        self.client = anthropic.Anthropic(api_key=api_key)
        self.semaphore = Semaphore(max_concurrent)
        self.request_times = []
        self.rpm_limit = rpm_limit
        
        # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è
        self.cache_stats = {
            'total_requests': 0,
            'cache_hits': 0,
            'tokens_saved': 0
        }
    
    async def generate_report(
        self,
        analysis_data: Dict,
        report_format: str,
        climber_name: str,
        expert: str = None,
        neuro_type: str = None
    ) -> str:
        """
        –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç—á–µ—Ç–∞ —Å Prompt Caching
        
        Args:
            analysis_data: –î–∞–Ω–Ω—ã–µ –∞–Ω–∞–ª–∏–∑–∞ –≤–∏–¥–µ–æ
            report_format: –§–æ—Ä–º–∞—Ç (technical/client/detective/etc)
            climber_name: –ò–º—è —Å–∫–∞–ª–æ–ª–∞–∑–∞
            expert: –≠–∫—Å–ø–µ—Ä—Ç (–µ—Å–ª–∏ None - –≤—ã–±–∏—Ä–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)
            neuro_type: –ù–µ–π—Ä–æ—Ç–∏–ø (–µ—Å–ª–∏ None - –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)
        
        Returns:
            –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –æ—Ç—á–µ—Ç
        """
        
        async with self.semaphore:
            # Rate limiting
            await self._check_rate_limit()
            
            try:
                logger.info(f"üîÑ –í—ã–∑—ã–≤–∞–µ–º Claude API —Å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º...")
                logger.info(f"üìù –ü–∞—Ä–∞–º–µ—Ç—Ä—ã: format={report_format}, expert={expert}, neuro={neuro_type}")
                result = await self._generate_with_cache(
                    analysis_data,
                    report_format,
                    climber_name,
                    expert,
                    neuro_type
                )
                logger.info(f"‚úÖ Claude API —É—Å–ø–µ—à–Ω–æ –≤–µ—Ä–Ω—É–ª –æ—Ç—á–µ—Ç ({len(result)} —Å–∏–º–≤–æ–ª–æ–≤)")
                return result
            
            except anthropic.RateLimitError as e:
                print(f"‚ö†Ô∏è  Rate limit! Waiting 10 seconds...")
                await asyncio.sleep(10)
                return await self.generate_report(
                    analysis_data, report_format, climber_name, expert, neuro_type
                )
            
            except Exception as e:
                print(f"‚ùå Claude API error: {e}")
                print(f"üîÑ Falling back to local generation...")
                # Fallback –Ω–∞ –ª–æ–∫–∞–ª—å–Ω—É—é –≥–µ–Ω–µ—Ä–∞—Ü–∏—é
                return self._generate_fallback_report(
                    analysis_data, report_format, climber_name, expert, neuro_type
                )
    
    async def _generate_with_cache(
        self,
        data: Dict,
        format: str,
        name: str,
        expert: str = None,
        neuro: str = None
    ) -> str:
        """–ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è"""
        
        # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –≤—ã–±–æ—Ä —ç–∫—Å–ø–µ—Ä—Ç–∞ –µ—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω
        if not expert:
            expert = self._select_expert(data)
        
        # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –Ω–µ–π—Ä–æ—Ç–∏–ø–∞
        if not neuro:
            neuro = self._determine_neuro_type(data)
        
        # –°—Ç—Ä–æ–∏–º —É–Ω–∏–∫–∞–ª—å–Ω—É—é —á–∞—Å—Ç—å –ø—Ä–æ–º–ø—Ç–∞
        user_prompt = self._build_user_prompt(data, format, name, expert, neuro)
        
        # –ö–õ–Æ–ß–ï–í–û–ô –ú–û–ú–ï–ù–¢: System messages —Å cache_control
        # –û–±—ä–µ–¥–∏–Ω—è–µ–º –≤—Å–µ —Å–∏—Å—Ç–µ–º–Ω—ã–µ –ø—Ä–æ–º–ø—Ç—ã –≤ –æ–¥–Ω—É —Å—Ç—Ä–æ–∫—É (–≤–∫–ª—é—á–∞—è BoulderVision)
        system_prompt = f"{SYSTEM_BASE}\n\n{EXPERTS_INFO}\n\n{FORMATS_INFO}\n\n{NEURO_TYPES_INFO}\n\n{BOULDERVISION_INFO}"
        
        # –í—ã–∑–æ–≤ API
        response = self.client.messages.create(
            model="claude-sonnet-4-20250514",
            max_tokens=4000,
            system=system_prompt,
            messages=[
                {
                    "role": "user",
                    "content": user_prompt
                }
            ]
        )
        
        # –õ–æ–≥–∏—Ä—É–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∫—ç—à–∞
        if hasattr(response, 'usage') and response.usage:
            self._log_cache_usage(response.usage)
        
        return response.content[0].text
    
    def _build_user_prompt(
        self, 
        data: Dict, 
        format: str, 
        name: str,
        expert: str,
        neuro: str
    ) -> str:
        """–°—Ç—Ä–æ–∏—Ç —É–Ω–∏–∫–∞–ª—å–Ω—É—é —á–∞—Å—Ç—å –ø—Ä–æ–º–ø—Ç–∞ (–Ω–µ –∫—ç—à–∏—Ä—É–µ—Ç—Å—è)"""
        
        # –ò–∑–≤–ª–µ–∫–∞–µ–º BoulderVision –¥–∞–Ω–Ω—ã–µ –µ—Å–ª–∏ –µ—Å—Ç—å
        bv_data = data.get('bouldervision', {})
        holds_data = data.get('holds_analysis', {})
        
        bv_section = ""
        if bv_data:
            bv_section = f"""
BOULDERVISION –ú–ï–¢–†–ò–ö–ò:
- –°—Ä–µ–¥–Ω–∏–π Velocity Ratio: {bv_data.get('avg_velocity_ratio', 'N/A')}
- –ú–∞–∫—Å. Velocity Ratio: {bv_data.get('max_velocity_ratio', 'N/A')} (–∫–∞–¥—Ä #{bv_data.get('peak_velocity_frame', 'N/A')})
- –ú–∏–Ω. Velocity Ratio: {bv_data.get('min_velocity_ratio', 'N/A')} (–∫–∞–¥—Ä #{bv_data.get('slowest_frame', 'N/A')})
- –ù–∞–∫–æ–ø–ª–µ–Ω–Ω–∞—è –¥–∏—Å—Ç–∞–Ω—Ü–∏—è: {bv_data.get('total_distance', 'N/A')}
- –ü–∞—Ç—Ç–µ—Ä–Ω –¥–≤–∏–∂–µ–Ω–∏—è: {bv_data.get('movement_pattern', 'N/A')}
- –í—Ä–µ–º—è –≤ –∑–æ–Ω–∞—Ö: –≤–µ—Ä—Ö {bv_data.get('time_zones', {}).get('upper', 0)}%, —Å–µ—Ä–µ–¥–∏–Ω–∞ {bv_data.get('time_zones', {}).get('middle', 0)}%, –Ω–∏–∑ {bv_data.get('time_zones', {}).get('lower', 0)}%
"""
        
        holds_section = ""
        if holds_data and holds_data.get('analysis_available'):
            longest = holds_data.get('longest_hold', {})
            holds_section = f"""
–ê–ù–ê–õ–ò–ó –ó–ê–¶–ï–ü–û–í:
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ –∑–∞—Ü–µ–ø–æ–≤: {holds_data.get('total_holds_used', 0)}
- –í—Å–µ–≥–æ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–π: {holds_data.get('total_interactions', 0)}
- –°–∞–º—ã–π –¥–æ–ª–≥–∏–π –∑–∞—Ü–µ–ø: {longest.get('color', 'N/A')} —Ü–≤–µ—Ç, {longest.get('time_seconds', 0):.1f} —Å–µ–∫
- –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ —Ü–≤–µ—Ç–∞–º: {holds_data.get('color_distribution', {})}
"""
        
        return f"""
–î–ê–ù–ù–´–ï –ê–ù–ê–õ–ò–ó–ê –í–ò–î–ï–û:
{json.dumps(data, ensure_ascii=False, indent=2)}
{bv_section}
{holds_section}

–ü–ê–†–ê–ú–ï–¢–†–´ –û–¢–ß–ï–¢–ê:
- –§–æ—Ä–º–∞—Ç: {format}
- –ò–º—è —Å–∫–∞–ª–æ–ª–∞–∑–∞: {name}
- –í—ã–±—Ä–∞–Ω–Ω—ã–π —ç–∫—Å–ø–µ—Ä—Ç: {expert}
- –ù–µ–π—Ä–æ—Ç–∏–ø: {neuro}

–ò–ù–°–¢–†–£–ö–¶–ò–ò –ü–û –§–û–†–ú–ê–¢–£:
{FORMAT_PROMPTS.get(format, FORMAT_PROMPTS['client'])}

–°–æ–∑–¥–∞–π –ü–û–õ–ù–´–ô –æ—Ç—á–µ—Ç –≤ —Ñ–æ—Ä–º–∞—Ç–µ "{format}" –°–ï–ô–ß–ê–°.
–í–∫–ª—é—á–∏ –í–°–ï 13 –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ –∏–∑ —Å–ø–∏—Å–∫–∞ (–≤–∫–ª—é—á–∞—è BoulderVision –¥–∏–Ω–∞–º–∏–∫—É –∏ –∞–Ω–∞–ª–∏–∑ –∑–∞—Ü–µ–ø–æ–≤ –µ—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ –¥–æ—Å—Ç—É–ø–Ω—ã).
–ò—Å–ø–æ–ª—å–∑—É–π –†–ï–ê–õ–¨–ù–´–ï –¥–∞–Ω–Ω—ã–µ –∏–∑ –∞–Ω–∞–ª–∏–∑–∞.
–û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∏—Ä—É–π BoulderVision –º–µ—Ç—Ä–∏–∫–∏ –µ—Å–ª–∏ –æ–Ω–∏ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω—ã!
"""
    
    def _select_expert(self, data: Dict) -> str:
        """–í—ã–±–æ—Ä —ç–∫—Å–ø–µ—Ä—Ç–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤"""
        avg_quality = data.get('avg_pose_quality', 70)
        fall_detected = data.get('fall_detected', False)
        
        if avg_quality >= 80:
            return random.choice(['Magnus Midtb√∏', 'Eric H√∂rst'])
        elif avg_quality >= 60:
            return random.choice(['Neil Gresham', 'Dave MacLeod'])
        elif fall_detected:
            return random.choice(['Neil Gresham', 'Dave MacLeod'])
        else:
            return random.choice(['Magnus Midtb√∏', 'Eric H√∂rst'])
    
    def _determine_neuro_type(self, data: Dict) -> str:
        """–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –Ω–µ–π—Ä–æ—Ç–∏–ø–∞"""
        avg_quality = data.get('avg_pose_quality', 70)
        avg_intensity = data.get('avg_motion_intensity', 15)
        
        # –§–ò–õ–û–°–û–§: –≤—ã—Å–æ–∫–∞—è —Ç–µ—Ö–Ω–∏–∫–∞, –Ω–∏–∑–∫–∞—è –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç—å
        if avg_quality > 80 and avg_intensity < 20:
            return "–§–ò–õ–û–°–û–§"
        # –í–û–ò–ù: —Å—Ä–µ–¥–Ω—è—è —Ç–µ—Ö–Ω–∏–∫–∞, –≤—ã—Å–æ–∫–∞—è –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç—å
        elif avg_quality > 70 and avg_intensity > 25:
            return "–í–û–ò–ù"
        # –ê–ù–ê–õ–ò–¢–ò–ö: –æ—á–µ–Ω—å –≤—ã—Å–æ–∫–∞—è —Ç–µ—Ö–Ω–∏–∫–∞
        elif avg_quality > 85:
            return "–ê–ù–ê–õ–ò–¢–ò–ö"
        # –°–ü–†–ò–ù–¢–ï–†: –æ—á–µ–Ω—å –≤—ã—Å–æ–∫–∞—è –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç—å
        elif avg_intensity > 30:
            return "–°–ü–†–ò–ù–¢–ï–†"
        else:
            return "–§–ò–õ–û–°–û–§"
    
    async def _check_rate_limit(self):
        """–ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ –æ–∂–∏–¥–∞–Ω–∏–µ –ø—Ä–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏ RPM"""
        now = time.time()
        
        # –£–±–∏—Ä–∞–µ–º –∑–∞–ø—Ä–æ—Å—ã —Å—Ç–∞—Ä—à–µ 1 –º–∏–Ω—É—Ç—ã
        self.request_times = [
            t for t in self.request_times 
            if now - t < 60
        ]
        
        # –ï—Å–ª–∏ –±–ª–∏–∑–∫–æ –∫ –ª–∏–º–∏—Ç—É (–æ—Å—Ç–∞–≤–ª—è–µ–º –∑–∞–ø–∞—Å 10 –∑–∞–ø—Ä–æ—Å–æ–≤)
        if len(self.request_times) >= self.rpm_limit - 10:
            wait = 60 - (now - self.request_times[0])
            if wait > 0:
                print(f"‚è≥ Rate limit approaching. Waiting {wait:.1f}s...")
                await asyncio.sleep(wait)
        
        # –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –≤—Ä–µ–º—è –∑–∞–ø—Ä–æ—Å–∞
        self.request_times.append(now)
    
    def _log_cache_usage(self, usage):
        """–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –∫—ç—à–∞"""
        self.cache_stats['total_requests'] += 1
        
        # –í –Ω–æ–≤–æ–π –≤–µ—Ä—Å–∏–∏ API —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ usage –∏–∑–º–µ–Ω–∏–ª–∞—Å—å
        if hasattr(usage, 'cache_read_input_tokens') and usage.cache_read_input_tokens > 0:
            self.cache_stats['cache_hits'] += 1
            self.cache_stats['tokens_saved'] += usage.cache_read_input_tokens
            
            print(f"üí∞ Cache HIT! Saved {usage.cache_read_input_tokens} tokens")
            print(f"   Stats: {self.cache_stats['cache_hits']}/{self.cache_stats['total_requests']} hits, "
                  f"{self.cache_stats['tokens_saved']} total tokens saved")
        else:
            print(f"üÜï Cache MISS - creating cache")
    
    def _generate_fallback_report(
        self, 
        data: Dict, 
        format: str, 
        name: str,
        expert: str = None,
        neuro_type: str = None
    ) -> str:
        """Fallback –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç—á–µ—Ç–∞ –±–µ–∑ Claude API"""
        
        quality = data.get('avg_pose_quality', 70)
        intensity = data.get('avg_motion_intensity', 15)
        balance = data.get('avg_balance_score', 70)
        overall = data.get('overall_quality', 70)
        frames = data.get('total_frames', 0)
        
        # –ü—Ä–æ–≥—Ä–µ—Å—Å –±–∞—Ä—ã
        def progress_bar(value):
            filled = int(value / 10)
            return '‚ñà' * filled + '‚ñë' * (10 - filled)
        
        report = f"""
üéØ CLIMBAI –ê–ù–ê–õ–ò–ó –î–í–ò–ñ–ï–ù–ò–Ø (Fallback Mode)

–ü—Ä–∏–≤–µ—Ç, {name}! üëã

üìä –û–°–ù–û–í–ù–ê–Ø –°–¢–ê–¢–ò–°–¢–ò–ö–ê
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
‚Ä¢ –ö–∞–¥—Ä–æ–≤ –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ: {frames}
‚Ä¢ –ü—Ä–æ–¥–æ–ª–∂–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: {data.get('duration', 0):.1f}—Å
‚Ä¢ –°—Ä–µ–¥–Ω–µ–µ FPS: {data.get('fps', 30)}

‚ö° –ú–ê–¢–†–ò–¶–ê –ü–†–û–ò–ó–í–û–î–ò–¢–ï–õ–¨–ù–û–°–¢–ò
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
–ö–ê–ß–ï–°–¢–í–û –ü–û–ó–´:    {progress_bar(quality)} {quality:.1f}%
–ò–ù–¢–ï–ù–°–ò–í–ù–û–°–¢–¨:    {progress_bar(intensity)} {intensity:.1f}
–ë–ê–õ–ê–ù–°:           {progress_bar(balance)} {balance:.1f}%
–û–ë–©–ê–Ø –û–¶–ï–ù–ö–ê:     {progress_bar(overall)} {overall:.1f}%

üë®‚Äçüè´ –≠–ö–°–ü–ï–†–¢–ù–´–ô –ê–ù–ê–õ–ò–ó
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
–ù–∞–∑–Ω–∞—á–µ–Ω–Ω—ã–π —ç–∫—Å–ø–µ—Ä—Ç: {expert or '–°–∏—Å—Ç–µ–º–∞'}
–û—Ü–µ–Ω–∫–∞: {quality:.0f}/100

{self._get_expert_comment(quality, expert)}

üî¨ –ë–ò–û–ú–ï–•–ê–ù–ò–ß–ï–°–ö–ò–ô –ê–ù–ê–õ–ò–ó
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
–ö–∞—á–µ—Å—Ç–≤–æ –¥–µ—Ç–µ–∫—Ü–∏–∏: {quality:.1f}%
{self._get_quality_interpretation(quality)}

–ò–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç—å –¥–≤–∏–∂–µ–Ω–∏–π: {intensity:.1f}
{self._get_intensity_interpretation(intensity)}

–ë–∞–ª–∞–Ω—Å —Ç–µ–ª–∞: {balance:.1f}%
{self._get_balance_interpretation(balance)}

üß† –ü–°–ò–•–û–õ–û–ì–ò–ß–ï–°–ö–ò–ô –ü–†–û–§–ò–õ–¨
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
–û–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–π –Ω–µ–π—Ä–æ—Ç–∏–ø: {neuro_type or '–§–ò–õ–û–°–û–§'}
{self._get_neuro_description(neuro_type)}

üéØ –ö–õ–Æ–ß–ï–í–´–ï –ú–û–ú–ï–ù–¢–´
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
–õ—É—á—à–∏–π –∫–∞–¥—Ä: #{data.get('best_frame', {}).get('frame_number', 'N/A')}
–•—É–¥—à–∏–π –∫–∞–¥—Ä: #{data.get('worst_frame', {}).get('frame_number', 'N/A')}

{'üö® –û–ë–ù–ê–†–£–ñ–ï–ù–û –ü–ê–î–ï–ù–ò–ï!' if data.get('fall_detected') else '‚úÖ –ü–∞–¥–µ–Ω–∏–π –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ'}

‚ö° –ü–õ–ê–ù –î–ï–ô–°–¢–í–ò–ô
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
üéØ –ü–†–Ø–ú–û –°–ï–ì–û–î–ù–Ø (5 –º–∏–Ω—É—Ç):
{self._get_immediate_actions(quality, balance)}

üìÖ –ù–ê –≠–¢–û–ô –ù–ï–î–ï–õ–ï:
{self._get_weekly_actions(quality, intensity)}

üöÄ –ù–ê –ú–ï–°–Ø–¶:
{self._get_monthly_goal(overall)}

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
‚ö†Ô∏è  FALLBACK –†–ï–ñ–ò–ú: –û—Ç—á–µ—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω –ª–æ–∫–∞–ª—å–Ω–æ
Claude API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω (–æ—à–∏–±–∫–∞ 403)
–í—Å–µ –º–µ—Ç—Ä–∏–∫–∏ –∏ –∞–Ω–∞–ª–∏–∑ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã!
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
"""
        return report.strip()
    
    def _get_expert_comment(self, quality: float, expert: str) -> str:
        if quality >= 80:
            return f"–û—Ç–ª–∏—á–Ω–∞—è —Ç–µ—Ö–Ω–∏–∫–∞! {expert or '–≠–∫—Å–ø–µ—Ä—Ç'} –±—ã–ª –±—ã –≤–ø–µ—á–∞—Ç–ª–µ–Ω —Ç–≤–æ–µ–π —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å—é."
        elif quality >= 60:
            return f"–•–æ—Ä–æ—à–∞—è –±–∞–∑–∞, –Ω–æ –µ—Å—Ç—å –Ω–∞–¥ —á–µ–º —Ä–∞–±–æ—Ç–∞—Ç—å. {expert or '–≠–∫—Å–ø–µ—Ä—Ç'} —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç –±–æ–ª—å—à–µ –ø—Ä–∞–∫—Ç–∏–∫–∏."
        else:
            return f"–¢–µ—Ö–Ω–∏–∫–∞ —Ç—Ä–µ–±—É–µ—Ç —Å–µ—Ä—å–µ–∑–Ω–æ–π —Ä–∞–±–æ—Ç—ã. {expert or '–≠–∫—Å–ø–µ—Ä—Ç'} —Å–æ–≤–µ—Ç—É–µ—Ç –Ω–∞—á–∞—Ç—å —Å –æ—Å–Ω–æ–≤."
    
    def _get_quality_interpretation(self, quality: float) -> str:
        if quality >= 80:
            return "–ü—Ä–µ–≤–æ—Å—Ö–æ–¥–Ω–æ! –¢–µ–ª–æ –æ—Ç–ª–∏—á–Ω–æ –¥–µ—Ç–µ–∫—Ç–∏—Ä—É–µ—Ç—Å—è, –ø–æ–∑–∞ —Å—Ç–∞–±–∏–ª—å–Ω–∞—è."
        elif quality >= 60:
            return "–•–æ—Ä–æ—à–æ. –ë–æ–ª—å—à–∏–Ω—Å—Ç–≤–æ –∫–∞–¥—Ä–æ–≤ —á–µ—Ç–∫–∏–µ, –µ—Å—Ç—å –º–æ–º–µ–Ω—Ç—ã –Ω–µ—Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏."
        else:
            return "–¢—Ä–µ–±—É–µ—Ç—Å—è —É–ª—É—á—à–µ–Ω–∏–µ. –ú–Ω–æ–≥–æ –∫–∞–¥—Ä–æ–≤ —Å –ø–ª–æ—Ö–æ–π –≤–∏–¥–∏–º–æ—Å—Ç—å—é –∫–ª—é—á–µ–≤—ã—Ö —Ç–æ—á–µ–∫."
    
    def _get_intensity_interpretation(self, intensity: float) -> str:
        if intensity >= 2.0:
            return "–û—á–µ–Ω—å –¥–∏–Ω–∞–º–∏—á–Ω—ã–µ –¥–≤–∏–∂–µ–Ω–∏—è! –í—ã—Å–æ–∫–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å."
        elif intensity >= 1.0:
            return "–£–º–µ—Ä–µ–Ω–Ω–∞—è –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç—å. –°–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–µ–º–ø."
        else:
            return "–ù–∏–∑–∫–∞—è –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç—å. –°—Ç–∞—Ç–∏—á–Ω—ã–µ –ø–æ–∑—ã –∏–ª–∏ –º–µ–¥–ª–µ–Ω–Ω—ã–µ –¥–≤–∏–∂–µ–Ω–∏—è."
    
    def _get_balance_interpretation(self, balance: float) -> str:
        if balance >= 80:
            return "–û—Ç–ª–∏—á–Ω—ã–π –±–∞–ª–∞–Ω—Å! –¶–µ–Ω—Ç—Ä –º–∞—Å—Å —Å—Ç–∞–±–∏–ª–µ–Ω."
        elif balance >= 60:
            return "–ù–µ–ø–ª–æ—Ö–æ–π –±–∞–ª–∞–Ω—Å, –Ω–æ –µ—Å—Ç—å –º–æ–º–µ–Ω—Ç—ã –Ω–µ—Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏."
        else:
            return "–ë–∞–ª–∞–Ω—Å —Ç—Ä–µ–±—É–µ—Ç —Ä–∞–±–æ—Ç—ã. –¶–µ–Ω—Ç—Ä –º–∞—Å—Å —á–∞—Å—Ç–æ —Å–º–µ—â–∞–µ—Ç—Å—è."
    
    def _get_neuro_description(self, neuro: str) -> str:
        descriptions = {
            "–§–ò–õ–û–°–û–§": "–°–ø–æ–∫–æ–π–Ω—ã–π, —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π, –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–π –ø–æ–¥—Ö–æ–¥ –∫ –ª–∞–∑–∞–Ω–∏—é",
            "–í–û–ò–ù": "–ê–≥—Ä–µ—Å—Å–∏–≤–Ω—ã–π, —Å–∏–ª–æ–≤–æ–π, –¥–∏–Ω–∞–º–∏—á–Ω—ã–π —Å—Ç–∏–ª—å",
            "–ê–ù–ê–õ–ò–¢–ò–ö": "–ú–µ—Ç–æ–¥–∏—á–Ω—ã–π, —Å–∏—Å—Ç–µ–º–Ω—ã–π, –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω—ã–π",
            "–°–ü–†–ò–ù–¢–ï–†": "–ë—ã—Å—Ç—Ä—ã–π, –∏–º–ø—É–ª—å—Å–∏–≤–Ω—ã–π, –∏–Ω—Ç—É–∏—Ç–∏–≤–Ω—ã–π"
        }
        return descriptions.get(neuro, "–°–ø–æ–∫–æ–π–Ω—ã–π, —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π –ø–æ–¥—Ö–æ–¥")
    
    def _get_immediate_actions(self, quality: float, balance: float) -> str:
        actions = []
        if quality < 70:
            actions.append("1. –£–ª—É—á—à–∏ –æ—Å–≤–µ—â–µ–Ω–∏–µ –ø—Ä–∏ —Å—ä–µ–º–∫–µ")
            actions.append("2. –°–Ω–∏–º–∞–π —Å –±–æ–ª–µ–µ –≤—ã–≥–æ–¥–Ω–æ–≥–æ —É–≥–ª–∞")
        else:
            actions.append("1. –°–¥–µ–ª–∞–π —Ä–∞–∑–º–∏–Ω–∫—É 3 –º–∏–Ω—É—Ç—ã")
            actions.append("2. –ü–æ–≤—Ç–æ—Ä–∏ –æ–¥–Ω–æ –¥–≤–∏–∂–µ–Ω–∏–µ 5 —Ä–∞–∑")
        
        if balance < 70:
            actions.append("3. –ü–æ—Å—Ç–æ–π –Ω–∞ –æ–¥–Ω–æ–π –Ω–æ–≥–µ 30 —Å–µ–∫")
        else:
            actions.append("3. –ó–∞–ø–∏—à–∏ —Å–≤–æ–∏ –æ—â—É—â–µ–Ω–∏—è")
        
        return '\n'.join(actions)
    
    def _get_weekly_actions(self, quality: float, intensity: float) -> str:
        actions = ["‚Ä¢ –ê–Ω–∞–ª–∏–∑–∏—Ä—É–π –ø–æ 2-3 –≤–∏–¥–µ–æ –≤ –Ω–µ–¥–µ–ª—é"]
        
        if quality < 70:
            actions.append("‚Ä¢ –†–∞–±–æ—Ç–∞–π –Ω–∞–¥ —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å—é –¥–≤–∏–∂–µ–Ω–∏–π")
        if intensity < 1.5:
            actions.append("‚Ä¢ –î–æ–±–∞–≤—å –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏—Ö —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π")
        
        return '\n'.join(actions)
    
    def _get_monthly_goal(self, overall: float) -> str:
        target = overall + 10
        return f"‚Ä¢ –î–æ—Å—Ç–∏—á—å –æ–±—â–µ–π –æ—Ü–µ–Ω–∫–∏ {target:.0f}% (—Å–µ–π—á–∞—Å {overall:.1f}%)"

    def get_cache_stats(self) -> Dict:
        """–ü–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è"""
        if self.cache_stats['total_requests'] == 0:
            return self.cache_stats
        
        hit_rate = self.cache_stats['cache_hits'] / self.cache_stats['total_requests'] * 100
        
        # –ü—Ä–∏–º–µ—Ä–Ω–∞—è —ç–∫–æ–Ω–æ–º–∏—è (cache read —Å—Ç–æ–∏—Ç ~10% –æ—Ç –æ–±—ã—á–Ω–æ–≥–æ input)
        savings_estimate = self.cache_stats['tokens_saved'] * 0.003 * 0.9  # 90% —ç–∫–æ–Ω–æ–º–∏—è
        
        return {
            **self.cache_stats,
            'hit_rate': f"{hit_rate:.1f}%",
            'estimated_savings': f"${savings_estimate:.3f}"
        }

# ============================================
# –ß–ê–°–¢–¨ 4: –ò–ù–¢–ï–ì–†–ê–¶–ò–Ø –í –ë–û–¢
# ============================================

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–µ–Ω–µ–¥–∂–µ—Ä–∞ (–û–î–ò–ù –†–ê–ó –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ –±–æ—Ç–∞)
import random
import os

# API –∫–ª—é—á –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
API_KEY = os.getenv("ANTHROPIC_API_KEY")

if not API_KEY:
    raise ValueError("ANTHROPIC_API_KEY –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!")

claude_manager = ClaudeManagerWithCaching(
    api_key=API_KEY,
    max_concurrent=5,      # –ú–∞–∫—Å 5 –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
    rpm_limit=1000         # Tier 2 = 1000 RPM
)

# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–µ –≤–∏–¥–µ–æ
async def handle_video_analysis(video_results, user_name, selected_format="client"):
    """
    –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ –±–æ—Ç–µ
    
    Args:
        video_results: –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–∞ –≤–∏–¥–µ–æ (dict)
        user_name: –ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        selected_format: –§–æ—Ä–º–∞—Ç –æ—Ç—á–µ—Ç–∞
    """
    
    try:
        # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –æ—Ç—á–µ—Ç
        report = await claude_manager.generate_report(
            analysis_data=video_results,
            report_format=selected_format,
            climber_name=user_name
        )
        
        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∫—ç—à–∞ (–¥–ª—è –¥–µ–±–∞–≥–∞)
        stats = claude_manager.get_cache_stats()
        print(f"\nüìä Cache Stats: {stats}")
        
        return report
        
    except Exception as e:
        print(f"‚ùå Error generating report: {e}")
        return None


# ============================================
# –ü–†–ò–ú–ï–† –ò–°–ü–û–õ–¨–ó–û–í–ê–ù–ò–Ø
# ============================================

async def example_usage():
    """–ü—Ä–∏–º–µ—Ä –∫–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å"""
    
    # –ü—Ä–∏–º–µ—Ä –¥–∞–Ω–Ω—ã—Ö –∞–Ω–∞–ª–∏–∑–∞
    fake_analysis = {
        'avg_pose_quality': 81.4,
        'avg_motion_intensity': 16.6,
        'total_frames': 265,
        'duration': 10.6,
        'fall_detected': True,
        'fall_timestamp': 21.07,
        'best_frame': {'frame': 545, 'quality': 98},
        'worst_frame': {'frame': 1270, 'quality': 51}
    }
    
    # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Ä–∞–∑–Ω—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã
    formats = ['client', 'technical', 'gamer']
    
    for fmt in formats:
        print(f"\n{'='*50}")
        print(f"Generating {fmt} report...")
        print(f"{'='*50}\n")
        
        report = await claude_manager.generate_report(
            analysis_data=fake_analysis,
            report_format=fmt,
            climber_name="–í–∏—Ç–∞–ª–∏–π"
        )
        
        print(report[:500])  # –ü–µ—Ä–≤—ã–µ 500 —Å–∏–º–≤–æ–ª–æ–≤
        print("\n...")
    
    # –ò—Ç–æ–≥–æ–≤–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
    final_stats = claude_manager.get_cache_stats()
    print(f"\n{'='*50}")
    print(f"FINAL CACHE STATISTICS:")
    print(f"{'='*50}")
    for key, value in final_stats.items():
        print(f"{key}: {value}")


if __name__ == "__main__":
    # –ó–∞–ø—É—Å–∫ –ø—Ä–∏–º–µ—Ä–∞
    asyncio.run(example_usage())
