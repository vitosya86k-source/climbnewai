# ClimbAI — Новый алгоритм определения уровня (v2)

## Зачем переделан

Старый алгоритм систематически занижал уровень по трём причинам:

1. **Считал по 3 секундам, а не по всему видео** — `technique_metrics_history` был обрезан до 90 кадров
2. **Жёсткие пороги не учитывали шум MediaPipe** — дрожание landmarks на лодыжках и тазе снижало оценки на 8-12 пунктов
3. **Перекос весов** — `quiet_feet` и `hip_position` (самые зашумлённые) имели вес 0.20 каждая

## Что изменилось

### Расширенная шкала категорий

Добавлены категории для скалодромов РФ (выше 8b на скалодромах не встречается):

| Скор | Категория |
|------|-----------|
| 95+  | 8b        |
| 92   | 8a+—8b    |
| 89   | 8a+       |
| 86   | 8a        |
| 83   | 7c+—8a    |
| 80   | 7c+       |
| 77   | 7c        |
| 74   | 7b+—7c    |
| 70   | 7b+       |
| 66   | 7a—7b     |
| 62   | 6c—7a     |
| 57   | 6b—6c     |
| 51   | 6a—6b     |
| 44   | 5c—6a     |
| 37   | 5b—5c     |
| 28   | 5a—5b     |
| 0    | до 5a     |

### Новые веса метрик

```
quiet_feet:      0.15  (было 0.20)  — снижен из-за шума MediaPipe
hip_position:    0.15  (было 0.20)  — снижен из-за артефактов камеры
diagonal:        0.15  (без изменений)
grip_release:    0.15  (без изменений)
rhythm:          0.15  (было 0.10)  — повышен, ритм хорошо различает уровни
dynamic_control: 0.15  (было 0.10)  — повышен, динамика = индикатор уровня
route_reading:   0.10  (без изменений)
```

### Компенсация шума MediaPipe

К итоговому скору добавляется **+8 баллов** — это компенсация систематического занижения из-за дрожания landmarks. Значение подобрано эмпирически.

### Бонус за сложность движений (до +8 баллов)

Если есть `video_stats`, начисляются бонусы:

| Признак | Условие | Бонус |
|---------|---------|-------|
| Быстрое лазание | >1.2 перехватов/сек | +3 |
| Очень быстрое лазание | >1.8 перехватов/сек | +5 |
| Элементы динамики | 1-2 динамич. движения | +2 |
| Серьёзная динамика | 3+ динамич. движений | +4 |
| Сложные растяжки | разлёт рук >0.7 роста | +2 |

Суммарный бонус ограничен 8 баллами.

### Агрегация по всему видео

```python
# БЫЛО: последние 90 кадров (≈3 сек)
avg = mean(history[-90:])

# СТАЛО: всё видео целиком, медиана вместо среднего
avg = median(history)  # без ограничений — видео до 2 мин
```

Медиана устойчивее к выбросам (случайные кадры где MediaPipe "сломался").

### Смягчённые пороги отдельных метрик

#### quiet_feet
```
Было: <1.5 перестановок → 90-100
Стало: <2.0 перестановок → 90-100
```
MediaPipe даёт ложные микро-перестановки из-за дрожания координат лодыжек.

#### hip_position
```
Было: <10° → 90-100
Стало: <15° → 90-100
```
При съёмке сбоку или снизу угол систематически завышен.

#### rhythm
```
Было: std ≤100ms → 90-100
Стало: std ≤150ms → 90-100
```

#### grip_release
```
Было: штраф 20 за рывок
Стало: штраф 15 за рывок
```

#### dynamic_control
```
Было: нет динамики → 100
Стало: нет динамики → 80 (отсутствие динамики ≠ идеальный контроль)
```

## Как интегрировать

### Вариант 1: Drop-in замена

```python
# В swot_generator.py заменить вызов estimate_grade:
from grade_algorithm import get_climbing_grade

# Вместо старого кода:
grade, score = get_climbing_grade(overlays)
```

### Вариант 2: Только функция оценки

```python
from grade_algorithm import estimate_grade, aggregate_metrics_history

# Агрегировать метрики
avg_metrics = aggregate_metrics_history(overlays.technique_metrics_history)

# Получить уровень
grade, score = estimate_grade(avg_metrics, video_stats=None)
```

### Вариант 3: С video_stats

```python
from grade_algorithm import estimate_grade, aggregate_metrics_history, collect_video_stats

avg_metrics = aggregate_metrics_history(overlays.technique_metrics_history)
video_stats = collect_video_stats(overlays)
grade, score = estimate_grade(avg_metrics, video_stats)
```

## Структура файла `grade_algorithm.py`

```
1. КОНФИГУРАЦИЯ           — веса, пороги, константы
2. estimate_grade()       — главная функция (метрики → категория)
3. _calc_complexity_bonus — бонус за сложность движений
4. _score_to_grade        — перевод числа в категорию
5. aggregate_metrics_history — агрегация по всему видео (медиана)
6. calc_*_score           — исправленные формулы каждой метрики
7. collect_video_stats    — хелпер для сбора доп. статистики
8. get_climbing_grade     — drop-in замена для swot_generator.py
```

## Что нужно сделать в существующем коде

1. **swot_generator.py** — убрать обрезку `technique_metrics_history[-90:]` полностью (не заменять на другой лимит), заменить вызов `estimate_grade`
2. **technique_metrics.py** — заменить функции расчёта метрик на версии из `grade_algorithm.py` (или импортировать)
3. **overlays** (или где хранятся данные) — добавить поля `hand_moves_count`, `dynamic_moves_count`, `max_reach_ratio` если хотите бонус за сложность
4. Протестировать на 3-5 видео разного уровня и при необходимости подкрутить `NOISE_COMPENSATION`

## Тонкая настройка

Если после интеграции уровень всё ещё кажется заниженным/завышенным:

- **Занижает** → увеличить `NOISE_COMPENSATION` (сейчас 8, попробовать 10-12)
- **Завышает** → уменьшить `NOISE_COMPENSATION` (попробовать 5-6)
- **Неточен на конкретных метриках** → подкрутить пороги в соответствующей `calc_*_score` функции
